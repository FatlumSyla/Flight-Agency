<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Agency - Premium Booking</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --success: #22c55e;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            margin: 0;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        h2 {
            margin-top: 0;
            font-size: 1.5rem;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }

        button.secondary {
            background-color: transparent;
            border: 1px solid var(--text-muted);
        }

        button.danger {
            background-color: var(--danger);
        }

        .auth-container {
            max-width: 400px;
            margin: 4rem auto;
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: white;
            box-sizing: border-box;
            /* Fix input overflow */
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-4px);
        }

        .flight-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .route {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .time {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success);
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.1);
        }

        .status-booked {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .status-cancelled {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .hidden {
            display: none;
        }

        #notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 2rem;
            border-radius: 8px;
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateY(150%);
            transition: transform 0.3s;
            z-index: 100;
        }

        #notification.show {
            transform: translateY(0);
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
        }

        .tab.active {
            border-color: var(--primary);
            color: white;
        }

        .search-container {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .search-grid .form-group {
            margin-bottom: 0;
        }
    </style>
</head>

<body>

    <div id="auth-view" class="container">
        <div class="auth-container">
            <h2 id="auth-title">Login</h2>
            <form id="auth-form">
                <div class="form-group" id="name-group" style="display:none;">
                    <label>Name</label>
                    <input type="text" id="name-input">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email-input" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password-input" required>
                </div>
                <button type="submit" id="auth-submit">Login</button>
                <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-muted);">
                    <span id="auth-switch-text">Don't have an account?</span>
                    <a href="#" id="auth-switch" style="color: var(--primary);">Register</a>
                </p>
            </form>
        </div>
    </div>

    <div id="app-view" class="container hidden">
        <header>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <h1>FlightAgency</h1>
                <span class="status-badge" style="background: var(--primary); color: white;">BETA</span>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span id="user-name" style="color: var(--text-muted);"></span>
                <button class="secondary" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('flights')">Available Flights</div>
            <div class="tab" onclick="switchTab('bookings')">My Bookings</div>
        </div>

        <div id="flights-tab">
            <div class="search-container">
                <form id="search-form" class="search-grid">
                    <div class="form-group">
                        <label>Origin</label>
                        <input type="text" id="search-origin" placeholder="e.g. New York">
                    </div>
                    <div class="form-group">
                        <label>Destination</label>
                        <input type="text" id="search-destination" placeholder="e.g. London">
                    </div>
                    <div class="form-group">
                        <label>Min Price</label>
                        <input type="number" id="search-min-price" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Max Price</label>
                        <input type="number" id="search-max-price" placeholder="1000">
                    </div>
                    <div class="form-group">
                        <label>Sort By</label>
                        <select id="search-sort-by"
                            style="width:100%; padding:0.75rem; background:rgba(0,0,0,0.2); border:1px solid rgba(255,255,255,0.1); border-radius:6px; color:white;">
                            <option value="depart_time">Departure Time</option>
                            <option value="price">Price</option>
                        </select>
                    </div>
                    <button type="submit">Search</button>
                    <button type="button" class="secondary" onclick="resetSearch()">Reset</button>
                </form>
            </div>
            <div id="flights-list" class="grid">
                <!-- Flights injected here -->
            </div>
        </div>

        <div id="bookings-tab" class="hidden">
            <div class="search-container" style="margin-bottom: 2rem;">
                <div class="search-grid">
                    <div class="form-group">
                        <label>Sort By</label>
                        <select id="booking-sort-by" onchange="loadBookings()"
                            style="width:100%; padding:0.75rem; background:rgba(0,0,0,0.2); border:1px solid rgba(255,255,255,0.1); border-radius:6px; color:white;">
                            <option value="created_at">Booking Date</option>
                            <option value="depart_time">Departure Time</option>
                            <option value="total_price">Total Price</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Order</label>
                        <select id="booking-sort-order" onchange="loadBookings()"
                            style="width:100%; padding:0.75rem; background:rgba(0,0,0,0.2); border:1px solid rgba(255,255,255,0.1); border-radius:6px; color:white;">
                            <option value="DESC">Descending</option>
                            <option value="ASC">Ascending</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="bookings-list" class="grid">
                <!-- Bookings injected here -->
            </div>
            <div id="bookings-pagination"
                style="margin-top: 2rem; display: flex; justify-content: center; gap: 1rem; align-items: center;">
                <!-- Pagination injected here -->
            </div>
        </div>
    </div>

    <div id="notification">Action successful</div>

    <script>
        const API_URL = 'http://localhost:4000/api';
        let token = localStorage.getItem('token');
        let user = JSON.parse(localStorage.getItem('user'));
        let isRegister = false;

        // --- Auth Logic ---
        function updateAuthView() {
            if (token) {
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                document.getElementById('user-name').textContent = user?.name || 'User';
                loadFlights();
            } else {
                document.getElementById('auth-view').classList.remove('hidden');
                document.getElementById('app-view').classList.add('hidden');
            }
        }

        document.getElementById('auth-switch').onclick = (e) => {
            e.preventDefault();
            isRegister = !isRegister;
            document.getElementById('auth-title').textContent = isRegister ? 'Create Account' : 'Login';
            document.getElementById('auth-submit').textContent = isRegister ? 'Register' : 'Login';
            document.getElementById('name-group').style.display = isRegister ? 'block' : 'none';
            document.getElementById('auth-switch-text').textContent = isRegister ? 'Already have an account?' : "Don't have an account?";
            document.getElementById('auth-switch').textContent = isRegister ? 'Login' : 'Register';
        };

        document.getElementById('auth-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            const name = document.getElementById('name-input').value;

            const endpoint = isRegister ? '/auth/register' : '/auth/login';
            const body = isRegister ? { name, email, password } : { email, password };

            try {
                const res = await fetch(API_URL + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();

                if (!res.ok) throw new Error(data.message || 'Auth failed');

                if (isRegister) {
                    showNotify('Registration successful! Please login.', 'success');
                    isRegister = false;
                    document.getElementById('auth-switch').click(); // Switch to login view
                    return;
                }

                token = data.accessToken;
                // Decode token payload simply to get user name if not provided
                // For now, let's just assume we get minimal info or store from form if register
                // Actually server doesn't return user object on login usually? 
                // Let's dummy user if needed or decoding
                // Assuming login returns { accessToken, refreshToken }

                // We'll set a dummy user name if not present
                user = { name: email.split('@')[0], email };
                localStorage.setItem('token', token);
                localStorage.setItem('user', JSON.stringify(user));
                updateAuthView();
                showNotify('Welcome back!', 'success');

            } catch (err) {
                showNotify(err.message, 'error');
            }
        };

        function logout() {
            token = null;
            user = null;
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            updateAuthView();
        }


        // --- App Logic ---
        function switchTab(tab) {
            if (tab === 'flights') {
                document.getElementById('flights-tab').classList.remove('hidden');
                document.getElementById('bookings-tab').classList.add('hidden');
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.querySelectorAll('.tab')[1].classList.remove('active');
                loadFlights();
            } else {
                document.getElementById('flights-tab').classList.add('hidden');
                document.getElementById('bookings-tab').classList.remove('hidden');
                document.querySelectorAll('.tab')[0].classList.remove('active');
                document.querySelectorAll('.tab')[1].classList.add('active');
                loadBookings();
            }
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const headers = {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                };
                const res = await fetch(API_URL + endpoint, {
                    method,
                    headers,
                    body: body ? JSON.stringify(body) : null
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Request failed');
                return data;
            } catch (err) {
                showNotify(err.message, 'error');
                if (err.message.includes('token')) logout();
                return null;
            }
        }

        async function loadFlights(searchParams = {}) {
            let endpoint = '/flights/search';
            const params = new URLSearchParams(searchParams);

            // If no search params, we could use the old /flights or just /flights/search with empty params
            // Let's use /flights/search for consistency
            if (params.toString()) {
                endpoint += `?${params.toString()}`;
            } else {
                // Default to all flights if no search
                endpoint = '/flights';
            }

            const data = await apiCall(endpoint);
            const container = document.getElementById('flights-list');
            if (!data) return;

            // Handle both /flights (array) and /flights/search (object with results)
            const flights = Array.isArray(data) ? data : data.results;

            if (flights.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); grid-column: 1/-1; text-align: center;">No flights found matching your criteria.</p>';
                return;
            }

            container.innerHTML = flights.map(f => `
                <div class="card">
                    <div class="flight-info">
                        <span class="route">${f.origin} â†’ ${f.destination}</span>
                        <span class="price">$${f.price}</span>
                    </div>
                    <div style="margin-bottom: 1rem; color: var(--text-muted);">
                        <div>${new Date(f.depart_time).toLocaleString()}</div>
                        <div>Flight: ${f.flight_number}</div>
                        <div style="margin-top: 0.5rem; color: ${f.available_seats > 0 ? 'var(--success)' : 'var(--danger)'}">
                            ${f.available_seats} seats remaining
                        </div>
                    </div>
                    <button 
                        onclick="bookFlight(${f.id})" 
                        style="width: 100%"
                        ${f.available_seats === 0 ? 'disabled style="opacity:0.5; cursor:not-allowed"' : ''}
                    >
                        ${f.available_seats === 0 ? 'Sold Out' : 'Book Now'}
                    </button>
                </div>
            `).join('');
        }

        document.getElementById('search-form').onsubmit = (e) => {
            e.preventDefault();
            const searchParams = {
                origin: document.getElementById('search-origin').value,
                destination: document.getElementById('search-destination').value,
                minPrice: document.getElementById('search-min-price').value,
                maxPrice: document.getElementById('search-max-price').value,
                sortBy: document.getElementById('search-sort-by').value
            };

            // Clean up empty params
            Object.keys(searchParams).forEach(key => !searchParams[key] && delete searchParams[key]);

            loadFlights(searchParams);
        };

        function resetSearch() {
            document.getElementById('search-form').reset();
            loadFlights();
        }

        async function bookFlight(flightId) {
            const seats = prompt("How many seats?", "1");
            if (!seats) return;

            const res = await apiCall('/bookings', 'POST', {
                flightId,
                seats: parseInt(seats)
            });

            if (res) {
                showNotify('Booking confirmed!');
                loadFlights(); // Refresh availability
            }
        }

        let bookingOffset = 0;
        const BOOKING_LIMIT = 5;

        async function loadBookings(offset = 0) {
            bookingOffset = offset;
            const sortBy = document.getElementById('booking-sort-by').value;
            const sortOrder = document.getElementById('booking-sort-order').value;

            const data = await apiCall(`/bookings?sortBy=${sortBy}&sortOrder=${sortOrder}&limit=${BOOKING_LIMIT}&offset=${bookingOffset}`);
            const container = document.getElementById('bookings-list');
            const paginationContainer = document.getElementById('bookings-pagination');
            if (!data) return;

            const bookings = data.results;
            const total = data.total;

            if (bookings.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); grid-column: 1/-1; text-align: center;">No bookings found.</p>';
                paginationContainer.innerHTML = '';
                return;
            }

            container.innerHTML = bookings.map(b => `
                <div class="card">
                    <div class="flight-info">
                        <span class="route">${b.origin} â†’ ${b.destination}</span>
                        <span class="status-badge status-${b.status}">${b.status.toUpperCase()}</span>
                    </div>
                    <div style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.875rem;">
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                            <span>Flight: <strong>${b.flight_number}</strong></span>
                            <span>$${b.flight_unit_price}/seat</span>
                        </div>
                        <div style="margin-bottom: 0.25rem;">
                            <i style="color: var(--primary);">ðŸ›«</i> Depart: ${new Date(b.depart_time).toLocaleString()}
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <i style="color: var(--primary);">ðŸ›¬</i> Arrive: ${new Date(b.arrive_time).toLocaleString()}
                        </div>
                        <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.05); margin: 0.5rem 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Seats: ${b.seats}</span>
                            <span style="font-size: 1.125rem; font-weight: 700; color: var(--success);">$${b.total_price}</span>
                        </div>
                        <div style="margin-top:0.5rem; font-size: 0.75rem; color: var(--text-muted);">
                            Booked on: ${new Date(b.created_at).toLocaleString()}
                        </div>
                    </div>
                    ${b.status !== 'cancelled' ? `
                        <button class="danger" onclick="cancelBooking(${b.id})" style="width: 100%">
                            Cancel Booking
                        </button>
                    ` : ''}
                </div>
            `).join('');

            // Pagination UI
            const totalPages = Math.ceil(total / BOOKING_LIMIT);
            const currentPage = Math.floor(bookingOffset / BOOKING_LIMIT) + 1;

            paginationContainer.innerHTML = `
                <button class="secondary" ${currentPage === 1 ? 'disabled style="opacity:0.5"' : ''} onclick="loadBookings(${(currentPage - 2) * BOOKING_LIMIT})">Prev</button>
                <span style="color: var(--text-muted)">Page ${currentPage} of ${totalPages}</span>
                <button class="secondary" ${currentPage === totalPages ? 'disabled style="opacity:0.5"' : ''} onclick="loadBookings(${currentPage * BOOKING_LIMIT})">Next</button>
            `;
        }

        async function cancelBooking(id) {
            if (!confirm('Are you sure you want to cancel?')) return;

            const res = await apiCall(`/bookings/${id}/cancel`, 'POST');
            if (res) {
                showNotify('Booking cancelled');
                loadBookings();
            }
        }

        function showNotify(msg, type = 'success') {
            const el = document.getElementById('notification');
            el.textContent = msg;
            el.style.borderLeft = `4px solid ${type === 'error' ? 'var(--danger)' : 'var(--success)'}`;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        // Init
        updateAuthView();

    </script>
</body>

</html>